
name: roofline-tp2-pp2
resources:
  cloud: aws
  accelerators: L40S:4
  use_spot: false
  disk_size: 500GB
  memory: "64GB+"
  region: us-east-1
num_nodes: 1
workdir: .
setup: | 
  export PYTHONHASHSEED=0
  set -euxo pipefail
  python3 -m pip install -U pip
  python3 -m pip install -U uv

  uv venv --python 3.12 --seed
  source .venv/bin/activate

  # Install vLLM and LMCache

  uv pip install "datasets" "requests" "pynvml"
  uv pip install "vllm==0.10.0" # old vllm
  # uv pip install "lmcache==0.3.11"
  git clone https://github.com/lmcache/lmcache.git
  cd lmcache
  git checkout v0.3.6
  uv pip install . --no-build-isolation
  cd ..

  mkdir -p /tmp/lmcache_disk

run: |
  set -euxo pipefail
  source .venv/bin/activate 
  # LMCache environment variables (must be set before Ray workers start)
  export LMCACHE_USE_EXPERIMENTAL="True"
  export LMCACHE_CHUNK_SIZE="256"
  export LMCACHE_LOCAL_CPU="True"
  export LMCACHE_MAX_LOCAL_CPU_SIZE="40.0"
  export LMCACHE_SAVE_UNFULL_CHUNK="True"
  # export VLLM_USE_RAY_COMPILED_DAG_CHANNEL_TYPE="shm"
  # export VLLM_USE_RAY_WRAPPED_PP_COMM=1
  export LMCACHE_ENABLE_ASYNC_LOADING="False"
  export LMCACHE_REMOTE_SERDE="cachegen"
  export LMCACHE_USE_LAYERWISE="True"
  export LMCACHE_ENABLE_LAZY_MEMORY_ALLOCATOR="True"
  export NCCL_P2P_DISABLE=1
  export NCCL_TIMEOUT=3600
  export TORCH_NCCL_BLOCKING_WAIT=1
  export TORCH_NCCL_ASYNC_ERROR_HANDLING=1
  export TORCH_NCCL_TRACE_BUFFER_SIZE=10000
  export TORCH_DISTRIBUTED_DEBUG=DETAIL
  export NCCL_DEBUG=INFO
  # export LMCACHE_LOOKUP_TIMEOUT_MS="12000"
  # export LMCACHE_LOCAL_DISK="/tmp/lmcache_disk"
  # export LMCACHE_MAX_LOCAL_DISK_SIZE="100"
  # export LMCACHE_DISK_PERSISTENCE="True"
  # export LMCACHE_LOG_LEVEL="INFO"

  # Start Ray on single node for pipeline parallelism
  export RAY_DASHBOARD_HOST=0.0.0.0
  export RAY_HEAD_PORT=6379
  export RAY_DASHBOARD_PORT=8265

  echo "Starting Ray for single-node pipeline parallelism..."
  uv run ray start --head --port=${RAY_HEAD_PORT} --dashboard-host=${RAY_DASHBOARD_HOST} --dashboard-port=${RAY_DASHBOARD_PORT} --num-cpus=0

  sleep 5
  uv run ray status --address="127.0.0.1:${RAY_HEAD_PORT}"

  # Run benchmark
  PYTHONHASHSEED=0 python roofline_benchmarks/benchmark_roofline-tp2-pp2.py

  # Cleanup Ray
  uv run ray stop
        

  echo "Cluster ready for benchmarking"
